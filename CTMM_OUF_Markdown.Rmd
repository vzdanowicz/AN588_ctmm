---
title: "CTMM Module Coyotes + Cougars"
author: "Frank Short"
date: "11/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Continuous-Time Movement Modeling - Coyotes and Cougars of Idaho

As shown in the background literature, advancements in movement modelling have allowed for more accurate home range estimates that account for both the time dimension and autocorrelation in global position system (GPS) data. Below is an example of the implementation of the R package ctmm (Contnuous-Time Movement Modeling) to calculate the autocorrelated kernel density estimates (AKDE) of cougars (*Puma concolor*) and coyotes (*Canis latrans*) from public available movement data (Mahoney & Young, 2017). The data from this study was collected via Lotek GPS collars (Model GPS3300S; Lotek, Newmarket, ON, Canada) on cougars and coyotes in Utah and Idaho respectively. We will begin by loading in a subset of our data. 



```{r Loading}
library(ctmm)
library(dplyr)
library(rlist)
# Loading in data

setwd("C:/Users/fshor/OneDrive/Desktop/Project Design in BioAnthro/Create a Module")
data=read.csv("Site fidelity in cougars and coyotes, Utah_Idaho USA (data from Mahoney et al. 2016)-gps.csv")

# Creating ctmm telemetry object
data=as.telemetry(data)

data=data[c(1,4)]
data=data[-2]
plot(data[[1]])
```

Creating a raw plot of our points demonstrates the wide area occupied by this individual coyote. 

## Creating and fitting models

The next step of our workflow is to create variograms from the GPS data for our individuals. Variograms represent autocorrelated data as the semi-variance between positions with varying time-lags. The structure of the variogram presents important information on the movement of an animal, as well as what method of movement modeling is best suited to the data. Arguably the most crucial element of a variogram is if the semi-variance reaches an asymptote. This indicates that an animal is range-resident, which allows our range calculation to be meaningful. Below I will create variograms for each of our individuals.

```{r variogram}
dt=c(3600,10800,14400)
control=list(method="pNewton",cores=2)
proto=ctmm(error=5,circle=FALSE)
variograms=lapply(1:1,function(i) variogram(data[[i]]))
plot(variograms[[1]],fraction = 0.5)
```

Dt represents an optional addition that delineates structural time lags in the data by seconds. Almost all of our coyote data is taken at 4 hour (14400 second) intervals, but other intervals occur. (Add something explaining control=list and the optimizer). Proto allows us to incorporate our estimation of the possible error present in the data, which we have included as 5 meters (I am unsure if this is the actual error for this GPS collar). We then use the ctmm function "variogram" to create a variograms for our individuals. As you can see from individual CO28's variogram, we have a good candidate for fitting a model. First, we have a long term dataset lasting from 6/2013 - 6/2014, which gives us a solid understanding of the ranging behavior of this individual. Second, our variogram reaches an asymptote at a semi-variance of about 3 square kilometers indicating range residency. 

## Model Fitting

(Talk about guess and ctmm.select here).

  In order to use autocorrelated kernel density estimation to perform accurate home range analyses, we have to ensure that our data indicates range residency and then choose the best model to represent the data. The first step as discussed above is to use a variogram to visualize whether movement is confined to a given space or home range. Then, a movement model is chosen. 
    The independent identically distributed (IID) process assumes each data point is independent and random. However, animal movement is automatically correlated since one's location in space is dependent on continuous movement. This means the IID model is not a good model for our purposes despite it's use in older kernel density estimation metrics. The brownian motion (BM) process assumes random movement and diffusion in unlimited space and is good for data not comprehensive enough to demonstrate home range or velocity autocorrelation. Typically, BM processes are not suitable for our purposes. However, the Ohrnstein-Uhlenbeck (OU) process uses BM but assumes fidelity to a general location and is suitable for data which shows signs of residency. What this model lacks is the ability to incorporate autocorrelated velocities. The integrated OU (IOU) process solves this problem for data with high resolution but is unable to demonstrate range residency. All of these shortcomings are solved in the Ohrnstein-Uhlenbeck Foraging (OUF) process which combines OU and IOU processes to enable analysis of data demonstrating both velocity autocorrelation and range residency. 
    This is especially relevant for improved data sampling methods which are able to combine long sampling periods and high resolution of sampling points. Given our extensive cougar and coyote data, we can expect that our best fit movement model might be the OUF model. We also have to differentiate between the accuracy of isotropic versus anisotropic models for each movement model. By running ctmm.fit and ctmm.select, we can produce data to determine the best fit model. Once we have decided between isotropic and anisotropic, we can proceed to visualize that version of the IID, OU, and OUF models to confirm the results of the initial model guess. 
    After confirming our model, we use this as the input for the AKDE. To use AKDE analysis appropriately, the data and model for the data must both demonstrate home range, and it is essential to select the best fitting model to produce accurate AKDE metric estimates. Plotting the AKDE estimate defaults to show the 95% home range contour and corresponding 95% confidence intervals. The summary produces point estimates and confidence intervals. One can also specify other confidence intervals if desired. 
    AKDE is an important advancement in animal habitat analysis. The previously popular method, kernel density estimation (KDE) utilized the IID model which led to underestimation of home range area due to its failure to consider movement data autocorrelation. The AKDE estimator more accurately estimates home range size which can aid in wildlife habitat protection.

```{r model}
guess=lapply(1:1,function(i) ctmm.guess(data[[i]], CTMM=proto,variogram=variograms[[i]],interactive=FALSE))
fits<-ctmm.select(data[[1]],guess[[1]],control=control)
summary(fits)

#plotting variogram and fit to see accuracy
plot(variograms[[1]],CTMM=fits,fraction= 0.5)
```

Our fitted model accurately represents the data when plotted over the variogram. 

## Autocorrelated Kernel Density Estimate Calculation

Now that we have fitted a continuous-time movement model, we can use this to begin calculating ecologically relevant metrics, such as home range size, range overlap, and occurrence distributions. 

```{r AKDE}
#Creating monthly AKDE from fitted model
uds=lapply(1:1,function(i) akde(data[[1]], fits))

#Plotting AKDE for CO28 (coyote)
plot(uds)

#AKDE area for CO28 (coyote)
summary(uds[[1]])

```


Here we can see the plotted AKDE for CO28, as well as the estimated home range size. 


